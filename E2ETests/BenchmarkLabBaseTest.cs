using Microsoft.Playwright;

namespace E2ETests
{
    abstract public class BenchmarkLabBaseTest : PageTest
    {
        const int TEST_SUITE_RUN_TIMEOUT = 60000;

        public override BrowserNewContextOptions ContextOptions()
        {
            return TestConfig.ContextOptions();
        }

        protected async Task ValidateBenchmarkCanRun(string benchmarkUrl, bool llmSummaryExpected = true, bool relatedBenchmarksExpected = true)
        {
            await Page.GotoAsync(benchmarkUrl);
            var suiteStatusLabel = Page.Locator("span.label.label-primary[data-role='suite-status']");
            await Expect(suiteStatusLabel).ToBeVisibleAsync();

            if (llmSummaryExpected)
            {
                var llmSummaryElement = Page.Locator("b", new PageLocatorOptions { HasTextString = "Autogenerated LLM Summary" });
                await Expect(llmSummaryElement).ToBeVisibleAsync();
            }

            var latestRunResultsElement = Page.Locator("b", new PageLocatorOptions { HasTextString = "Latest run results:" });
            await Expect(latestRunResultsElement).ToBeVisibleAsync();

            if (relatedBenchmarksExpected)
            {
                var relatedBenchmarksElement = Page.Locator("b", new PageLocatorOptions { HasTextString = "Related benchmarks:" });
                await Expect(relatedBenchmarksElement).ToBeVisibleAsync();
            }

            var runTestButton = Page.Locator("button#runTest");
            await runTestButton.ClickAsync();

            var runningStatusLabel = Page.Locator("span.label.label-info[data-role='suite-status']");
            await Expect(runningStatusLabel).ToBeVisibleAsync();
            await Expect(runningStatusLabel).ToHaveTextAsync("Running");

            var completedStatusLabel = Page.Locator("span.label.label-success[data-role='suite-status']");
            await Expect(completedStatusLabel).ToBeVisibleAsync(new LocatorAssertionsToBeVisibleOptions { Timeout = TEST_SUITE_RUN_TIMEOUT });
            await Expect(completedStatusLabel).ToHaveTextAsync("Completed", new LocatorAssertionsToHaveTextOptions { Timeout = TEST_SUITE_RUN_TIMEOUT });

            // Validate that the text of the fastest label is not empty
            var fastestLabel = Page.Locator("span[data-role='fastest-label']");
            await Expect(fastestLabel).ToBeVisibleAsync();
            await Expect(fastestLabel).Not.ToBeEmptyAsync();

            // Validate that the text of the slowest label is not empty
            var slowestLabel = Page.Locator("span[data-role='slowest-label']");
            await Expect(slowestLabel).ToBeVisibleAsync();
            await Expect(slowestLabel).Not.ToBeEmptyAsync();

            // Validate that there are more than 0 table rows with non-empty text
            var resultRows = Page.Locator("td[data-role='result-label']");
            var rowCount = await resultRows.CountAsync();
            Assert.IsTrue(rowCount > 0, "There should be more than 0 result rows.");

            for (int i = 0; i < rowCount; i++)
            {
                var rowText = await resultRows.Nth(i).TextContentAsync();
                Assert.IsFalse(string.IsNullOrWhiteSpace(rowText), $"Row {i} should not be empty.");
            }
        }
    }
}
